package com.tpnor.util;

import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import lombok.SneakyThrows;

import java.io.InputStreamReader;
import java.net.URL;
import java.util.concurrent.atomic.AtomicReference;

public class TenorUtil {

    public static final String API_KEY = "2JMA6TM6ULQ5";

    public static String getTenorGif(String input) {
        String url = input.replace("/", "");
        String[] splitURL = url.split("-");
        int gifID;

        try {
            gifID = Integer.parseInt(splitURL[splitURL.length - 1]);
        }catch (Exception e) {
            return null;
        }

        JsonObject result = getGson(gifID);
        AtomicReference<String> foundGifURL = new AtomicReference<>();

        result.get("results").getAsJsonArray().forEach(jsonElement -> {
            JsonObject jsonObject = jsonElement.getAsJsonObject();
            jsonObject.getAsJsonArray("media").forEach(mediaElement -> {
                JsonObject mediaObject = mediaElement.getAsJsonObject();
                foundGifURL.set(mediaObject.get("mp4").getAsJsonObject().get("preview").getAsString());
            });
        });

        return foundGifURL.get();

    }

    @SneakyThrows
    public static JsonObject getGson(int gifId) {
        return JsonParser.parseReader(new InputStreamReader(new URL(String.format("https://g.tenor.com/v1/gifs?ids=%1$s&key=%2$s",
                gifId, API_KEY)).openStream())).getAsJsonObject();
    }

}
